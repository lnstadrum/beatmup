/*
    Beatmup image and signal processing library
    Copyright (C) 2020, lnstadrum

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
STRINGIFY(
    layout(binding = 0, rgba8) uniform writeonly lowp image2D[6] outFeatures;
    uniform lowp beatmupSampler image;
    lowp float fetchLuma(highp ivec2 p) {
       return dot(texelFetch(image, p, 0).rgb, vec3(0.299, 0.587, 0.114));
    }
    void main() {
        lowp float ii[5][5];
        ii[0][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,-2));
        ii[1][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,-2));
        ii[2][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,-2));
        ii[3][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,-2));
        ii[4][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,-2));
        ii[0][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,-1));
        ii[1][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,-1));
        ii[2][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,-1));
        ii[3][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,-1));
        ii[4][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,-1));
        ii[0][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,0));
        ii[1][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,0));
        ii[2][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,0));
        ii[3][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,0));
        ii[4][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,0));
        ii[0][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,1));
        ii[1][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,1));
        ii[2][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,1));
        ii[3][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,1));
        ii[4][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,1));
        ii[0][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,2));
        ii[1][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,2));
        ii[2][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,2));
        ii[3][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,2));
        ii[4][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,2));

        lowp vec4 i[6];
        i[0] = vec4(ii[0][0], ii[1][0], ii[2][0], ii[3][0]);
        i[1] = vec4(ii[4][0], ii[0][1], ii[1][1], ii[2][1]);
        i[2] = vec4(ii[3][1], ii[4][1], ii[0][2], ii[1][2]);
        i[3] = vec4(ii[2][2], ii[3][2], ii[4][2], ii[0][3]);
        i[4] = vec4(ii[1][3], ii[2][3], ii[3][3], ii[4][3]);
        i[5] = vec4(ii[0][4], ii[1][4], ii[2][4], ii[3][4]);
        mediump vec4 sum;
    
        sum = vec4(0.12103, 0.23801, 0.01670, -1.22224) +
            i[0] * mat4(-0.000993,0.002601,0.010360,0.012087,-0.017644,0.002409,-0.005350,0.037653,0.011904,-0.019027,0.059759,0.025096,0.210622,-0.200085,-0.096617,0.177885) +
            i[1] * mat4(-0.034907,-0.000816,-0.044780,0.051386,-0.001349,0.009095,-0.021533,0.009771,-0.020445,-0.010086,0.084321,-0.238242,-0.132340,0.069390,-0.015241,-0.006420) +
            i[2] * mat4(0.015158,-0.004252,-0.000598,0.008735,-0.001068,0.008814,-0.001320,-0.035801,0.030098,-0.027490,0.041045,-0.018589,-0.181365,0.081053,-0.042383,-0.337644) +
            i[3] * mat4(-0.108622,-0.107332,-0.024152,0.005698,-0.041553,-0.086950,0.019060,0.014976,0.663355,-0.125103,0.107968,-0.047833,2.362099,-0.243966,0.037704,-0.385938) +
            i[4] * mat4(0.019908,-0.103819,0.602081,-0.000977,-0.056280,0.617331,-0.185371,0.022453,0.030963,-0.483591,0.036535,-0.035695,-10.943556,-0.304731,-0.068151,-0.052290) +
            i[5] * mat4(0.002398,-0.011372,-0.002397,-0.016949,0.009540,-0.097884,-0.067719,-0.053466,-0.018879,0.061452,0.150130,0.002328,-1.589461,-0.367392,0.063945,0.101446) +
            vec4(-0.016549, 0.013990, 0.004929, 0.089848) * ii[4][4];
        imageStore(outFeatures[0], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(-1.27182, 0.02103, 0.06169, 0.02553) +
            i[0] * mat4(-0.005065,0.020398,-0.051154,0.001751,0.018340,-0.025023,0.024814,-0.013510,0.052339,0.002618,-0.029617,-0.048287,0.053407,0.160885,0.176052,0.187503) +
            i[1] * mat4(0.023476,0.020869,-0.053991,-0.120176,-0.001818,0.025944,-0.049911,-0.031344,0.051230,-0.005704,0.170540,0.316830,0.167625,0.540263,-7.884494,-3.844006) +
            i[2] * mat4(-0.151230,-0.047635,-0.028494,-0.097853,0.004701,-0.002277,-0.043161,0.249058,0.118863,-0.074256,-0.055258,0.346494,-2.018597,0.057049,0.157084,0.138626) +
            i[3] * mat4(0.129623,2.149005,-0.643161,-0.015603,0.214236,-0.016112,-0.003564,-0.001233,-15.040040,0.338883,-0.033880,0.004320,0.080616,-0.258163,0.081775,-0.005680) +
            i[4] * mat4(0.020603,-0.208441,-0.145961,0.040398,0.284452,0.224924,-0.012998,0.005008,0.161928,0.326951,0.141706,0.009545,0.160534,0.200385,0.000431,0.097380) +
            i[5] * mat4(0.022754,-0.004227,-0.039109,0.009734,0.000079,0.022003,0.022526,0.013856,0.023811,-0.027445,-0.084215,-0.079067,0.021304,0.053854,-0.056083,0.027083) +
            vec4(0.023105, 0.002578, 0.041984, 0.022389) * ii[4][4];
        imageStore(outFeatures[1], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.08759, -1.63137, 0.13803, 0.02172) +
            i[0] * mat4(-0.089135,0.179288,0.346675,0.190945,0.493795,0.866382,0.347269,0.008884,-0.013070,-0.083137,0.138448,0.000924,-0.168045,0.348996,-0.037812,0.058842) +
            i[1] * mat4(0.027155,0.056065,0.163074,-3.340480,0.141645,0.459684,-11.911879,0.293256,0.077902,0.052543,-0.352389,-8.601992,-0.016567,0.247787,-0.684756,0.085900) +
            i[2] * mat4(0.165925,0.172076,0.227046,-4.176210,0.051597,0.037690,0.390008,0.589405,0.515130,0.112091,0.044051,-0.005122,-0.216341,0.070314,-0.127518,0.486193) +
            i[3] * mat4(-7.140024,-3.680979,0.156105,0.109899,0.371860,0.038789,0.073905,-0.086949,-0.049213,-0.072586,0.053943,-0.005531,0.204860,0.065010,0.022214,0.042066) +
            i[4] * mat4(0.182301,-4.329381,0.241423,0.202447,0.051311,0.105365,-0.026811,-0.008616,0.119077,0.037337,-0.011308,0.025937,-0.226923,-0.195428,-0.024894,-0.030566) +
            i[5] * mat4(-0.013059,0.217960,0.187904,0.138790,0.010301,0.135496,-0.028483,-0.062401,-0.004404,0.008421,0.029855,0.002529,-0.059053,0.180539,0.005622,-0.020351) +
            vec4(0.036360, 0.029663, -0.005030, -0.006526) * ii[4][4];
        imageStore(outFeatures[2], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.21346, 0.16951, 0.00405, 0.05409) +
            i[0] * mat4(-0.001980,0.008405,0.035402,0.072370,-0.009713,0.090497,0.016986,0.044854,-0.010718,0.001070,0.011826,0.009907,-0.195300,0.176257,-0.135208,0.022312) +
            i[1] * mat4(0.080122,0.027606,0.042766,-0.026292,0.038915,0.058164,0.065019,0.354404,-0.004830,0.000059,-0.016392,0.023233,-0.143468,0.088948,0.418506,-0.017725) +
            i[2] * mat4(0.109569,-0.006309,0.021109,0.037566,0.091500,0.035894,-0.016648,-0.140886,-0.033695,0.003458,0.016265,-0.053792,-0.008787,0.258528,-0.276929,1.105432) +
            i[3] * mat4(0.053485,-2.157261,0.082070,0.059446,-2.073906,0.264722,0.094288,0.077987,-1.464292,-0.067730,0.027633,-0.018817,-0.381364,-0.086101,0.317903,0.844790) +
            i[4] * mat4(-0.010982,-0.022314,0.625615,-0.053941,-0.018748,0.402050,0.132364,0.071382,0.062023,1.574309,0.073921,-0.013352,-1.464381,-4.350053,0.445930,0.187670) +
            i[5] * mat4(0.016195,-0.040327,-0.060821,-0.045482,-0.032376,0.028917,0.003707,-0.017757,0.003439,0.027675,-0.157063,0.005591,0.033569,-2.984518,0.240070,0.185170) +
            vec4(-0.008115, 0.011187, -0.002947, 0.255144) * ii[4][4];
        imageStore(outFeatures[3], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.00177, 0.48300, -0.01603, 0.06719) +
            i[0] * mat4(-0.021569,-0.089825,0.072791,-0.003418,0.208471,-0.030909,0.114554,0.056365,0.044684,-0.015608,-0.270800,-0.092612,0.018396,0.017954,0.016317,0.022369) +
            i[1] * mat4(-0.008333,0.306702,-1.055250,1.388922,0.071240,-0.041818,-0.232543,-3.004621,0.088697,-0.076596,0.715151,1.792750,0.024310,-0.004317,-0.697793,0.037345) +
            i[2] * mat4(-0.255891,0.104869,-0.058897,-0.042603,-0.077314,0.011196,0.169345,0.157126,1.120376,0.036445,0.096499,-0.778929,-0.019171,-0.005554,0.081402,1.503542) +
            i[3] * mat4(0.046984,0.017515,0.019090,-0.015185,-6.927587,-0.021934,0.104157,-0.029137,-1.717293,-1.062646,0.065100,-0.118923,0.082508,-0.066571,-0.005385,-0.040295) +
            i[4] * mat4(-0.036159,-0.067775,-0.018181,0.008685,0.116420,0.011401,-0.017810,0.028768,-0.035113,0.213316,-0.124632,-0.087970,-1.037636,-0.084738,0.041052,0.057682) +
            i[5] * mat4(0.005950,0.011951,0.016378,-0.025258,0.004099,0.105412,0.316848,0.195970,0.035212,0.087481,0.138085,0.009814,-0.035006,-0.071513,-0.039603,0.001099) +
            vec4(0.017523, 0.099207, -0.027254, 0.014684) * ii[4][4];
        imageStore(outFeatures[4], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(-1.81290, -0.17109, -2.29791, -0.00273) +
            i[0] * mat4(-0.051984,-0.027098,-0.021667,-0.048284,-0.002337,0.028635,0.021709,0.007712,-0.013144,-0.034294,0.019872,-0.046512,0.016239,-0.014110,-0.098983,0.002540) +
            i[1] * mat4(-0.067009,-0.027492,-0.023569,-0.018408,-0.022077,-0.013624,0.004643,0.108859,0.002194,-0.035030,0.046082,-0.023066,0.048124,-0.029756,0.296399,-0.329507) +
            i[2] * mat4(-0.019329,-0.032164,-0.109093,-0.002235,-0.008711,-0.006964,0.059104,0.011526,-0.027765,-0.031360,-0.055695,-0.056704,0.235680,-0.065641,-0.110750,0.162115) +
            i[3] * mat4(0.093974,0.072379,-0.047444,-0.045409,-1.697324,0.071791,0.024676,-0.014128,0.063236,-0.211304,-0.092591,-0.062432,-0.113373,-0.014936,-0.081428,0.405972) +
            i[4] * mat4(2.574539,0.131877,-0.034706,-0.064834,-0.001293,1.405629,0.058375,-0.044020,-0.092716,0.148394,2.915333,0.075504,-1.286338,2.052202,-1.469234,0.352734) +
            i[5] * mat4(0.091387,-0.256850,-0.073320,-0.028804,-0.034758,-0.022568,-0.193405,-0.034033,-0.068374,-0.033449,-0.073450,-0.084179,-0.210689,0.295132,-0.010243,0.014199) +
            vec4(-0.032071, 0.052579, 0.010987, -0.081644) * ii[4][4];
        imageStore(outFeatures[5], ivec2(gl_GlobalInvocationID.xy), sum);
        
    }
    )