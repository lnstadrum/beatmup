/*
    Beatmup image and signal processing library
    Copyright (C) 2020, lnstadrum

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
STRINGIFY(
    layout(binding = 0, rgba8) uniform writeonly lowp image2D[6] outFeatures;
    uniform lowp beatmupSampler image;
    lowp float fetchLuma(highp ivec2 p) {
       return dot(texelFetch(image, p, 0).rgb, vec3(0.299, 0.587, 0.114));
    }
    void main() {
        lowp float ii[5][5];
        ii[0][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,-2));
        ii[1][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,-2));
        ii[2][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,-2));
        ii[3][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,-2));
        ii[4][0] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,-2));
        ii[0][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,-1));
        ii[1][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,-1));
        ii[2][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,-1));
        ii[3][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,-1));
        ii[4][1] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,-1));
        ii[0][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,0));
        ii[1][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,0));
        ii[2][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,0));
        ii[3][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,0));
        ii[4][2] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,0));
        ii[0][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,1));
        ii[1][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,1));
        ii[2][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,1));
        ii[3][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,1));
        ii[4][3] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,1));
        ii[0][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-2,2));
        ii[1][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(-1,2));
        ii[2][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(0,2));
        ii[3][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(1,2));
        ii[4][4] = fetchLuma(ivec2(gl_GlobalInvocationID.xy) + ivec2(2,2));

        lowp vec4 i[6];
        i[0] = vec4(ii[0][0], ii[1][0], ii[2][0], ii[3][0]);
        i[1] = vec4(ii[4][0], ii[0][1], ii[1][1], ii[2][1]);
        i[2] = vec4(ii[3][1], ii[4][1], ii[0][2], ii[1][2]);
        i[3] = vec4(ii[2][2], ii[3][2], ii[4][2], ii[0][3]);
        i[4] = vec4(ii[1][3], ii[2][3], ii[3][3], ii[4][3]);
        i[5] = vec4(ii[0][4], ii[1][4], ii[2][4], ii[3][4]);
        mediump vec4 sum;
    
        sum = vec4(-2.51153, 0.16051, 0.02753, -2.30583) +
            i[0] * mat4(-0.010448,-0.017690,-0.010752,-0.004836,0.122211,0.079415,0.095909,0.344241,-0.035444,-0.111940,-0.490825,-0.291554,0.014821,0.023363,-0.005780,-0.004028) +
            i[1] * mat4(-0.015209,-0.010248,0.050136,0.149524,0.321778,0.245050,0.113416,-8.244999,-0.113343,-0.093418,-0.266164,1.550589,0.021280,-0.018607,0.019606,0.018238) +
            i[2] * mat4(-0.024049,-0.008464,0.008542,0.040394,-3.994846,0.137488,0.276190,-0.058824,-0.361184,-0.025761,0.008835,-0.206044,0.021016,-0.010107,0.015425,-0.041360) +
            i[3] * mat4(2.761049,0.043146,-0.037855,-0.019369,-5.374341,1.009109,-0.117133,0.030610,-0.288026,-0.162498,-0.136680,-0.013704,-0.027601,-0.080268,0.014585,-0.019575) +
            i[4] * mat4(0.008557,0.104031,-0.008495,0.025179,0.051765,0.168641,0.229311,-0.071418,-0.135682,0.027277,-0.024990,-0.026269,-0.062036,2.905930,-0.121253,-0.000383) +
            i[5] * mat4(-0.008112,-0.021707,-0.022455,-0.025014,0.042757,0.000517,-0.112393,0.197820,-0.061473,-0.010062,0.024071,0.014761,-0.009480,-0.063557,-0.230200,-0.082152) +
            vec4(-0.020112, 0.042833, 0.025941, -0.009227) * ii[4][4];
        imageStore(outFeatures[0], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(-0.70236, -0.85035, -2.27745, 0.11053) +
            i[0] * mat4(0.075651,0.126427,-0.031489,-0.045995,-0.010961,-0.019162,-0.007380,-0.013463,-0.017599,0.018702,-0.008424,-0.002009,0.009485,-0.048307,0.187227,-0.146030) +
            i[1] * mat4(-0.047878,0.414068,-1.830493,1.844672,-0.002304,-0.101580,0.062853,0.126133,-0.015272,-0.107289,-0.150046,-0.074302,0.070292,-0.019367,-0.065660,-0.157207) +
            i[2] * mat4(-0.083220,-0.002882,0.069936,0.215652,-0.109011,0.028859,-0.127805,-0.120471,0.011040,-0.004278,-0.135572,2.963505,0.240755,-0.164025,0.038612,0.146818) +
            i[3] * mat4(-0.111900,-0.104169,0.038173,-0.027322,1.858524,-0.223346,-0.037457,0.086906,-0.059698,-0.001066,0.010351,-0.035119,-0.100268,-0.150690,0.170790,-0.020958) +
            i[4] * mat4(-0.057126,-0.036663,-0.028712,0.047071,0.056164,-1.760982,0.346453,0.042152,-0.138990,-0.043615,-0.008878,-0.001385,-0.018950,-0.007644,0.062878,-0.146226) +
            i[5] * mat4(0.016735,0.057840,-0.047541,-0.043985,0.066645,0.033690,0.213370,-0.153778,-0.005311,-0.002294,-0.007646,-0.005593,0.029582,-0.076404,0.182609,-0.084183) +
            vec4(0.046887, 0.057672, 0.022062, 0.084808) * ii[4][4];
        imageStore(outFeatures[1], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.05201, -0.10461, -0.81887, -0.33572) +
            i[0] * mat4(0.032022,-0.080294,0.029243,-0.038670,-0.114294,-0.078201,0.020160,0.073933,0.027926,0.276727,-1.613889,0.175590,0.031808,0.002283,0.054188,-0.038361) +
            i[1] * mat4(0.024862,-0.084711,0.228198,-0.031008,-0.018578,-0.358179,1.581842,-2.466157,0.079912,-0.097493,-0.163050,2.026774,0.080512,-0.032891,0.049259,0.115437) +
            i[2] * mat4(0.004519,-0.025443,0.288039,-0.647956,0.020704,0.026526,-0.046204,-0.154300,-0.077502,-0.048020,0.071193,-0.072986,0.310063,0.165407,0.074582,-0.094515) +
            i[3] * mat4(0.320434,-0.166746,0.057178,-0.065782,0.196011,0.071513,-0.047328,0.012751,0.081357,-0.121779,0.014728,0.023233,0.007943,-8.134983,0.441461,-0.049771) +
            i[4] * mat4(0.281887,-0.037103,0.001031,0.006163,-0.032523,0.031382,0.033239,0.032291,-0.062520,-0.067674,-0.054151,0.083241,0.037934,0.099645,0.366732,0.150772) +
            i[5] * mat4(0.011537,-0.096823,-0.012667,-0.030176,-0.016685,-0.058529,0.060209,0.073807,0.033696,-0.027727,0.012700,-0.101360,0.034038,-0.056367,0.032502,0.006953) +
            vec4(0.020139, 0.012407, -0.009012, 0.125368) * ii[4][4];
        imageStore(outFeatures[2], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.00680, 0.27524, 0.34524, -0.00466) +
            i[0] * mat4(0.142224,0.016848,0.050259,0.275115,0.067565,0.046811,0.009989,0.119246,0.040033,-0.099619,0.008900,0.089287,-0.009463,-0.253872,-0.488504,1.346971) +
            i[1] * mat4(-0.462139,0.032662,-0.016051,-0.288092,-0.004956,0.214853,0.028670,-0.450404,-0.046108,-0.061024,0.035140,-0.328331,0.055789,0.169048,-0.013428,1.056601) +
            i[2] * mat4(-0.477644,0.971857,0.168988,-0.155536,0.100500,0.117904,0.210212,-0.153824,0.147660,0.123898,-0.056347,-0.338467,-0.090016,-1.327514,-0.098306,-0.036990) +
            i[3] * mat4(0.339871,0.229385,-1.398099,-0.242433,-3.296234,0.141604,0.052965,0.075976,0.194141,0.251162,-0.053452,-0.039102,0.033655,-1.032364,0.413728,-0.091916) +
            i[4] * mat4(0.697400,-1.314899,0.807736,0.771919,0.075186,-0.164791,-0.017465,0.077566,-0.146470,-0.026388,0.206750,0.082849,-0.036539,0.129050,-0.028317,0.277647) +
            i[5] * mat4(0.227891,-0.510371,1.092604,-0.907964,0.055778,0.173258,-0.029146,0.146916,0.031205,-0.007603,-0.005818,0.033810,0.033790,-0.001139,0.141019,-0.215856) +
            vec4(-0.077287, 0.070505, 0.015703, 0.049114) * ii[4][4];
        imageStore(outFeatures[3], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(-2.62488, -0.00024, -0.57288, -0.00039) +
            i[0] * mat4(-0.031084,0.015255,0.096002,-0.064340,-0.018774,0.385778,-0.139517,-0.061294,0.061153,0.039947,0.090410,-0.186633,0.070522,0.266394,-0.202753,-0.082783) +
            i[1] * mat4(-0.069042,-0.043441,0.084788,0.054262,-0.004437,0.387179,0.328533,-0.607527,-0.144904,0.042068,-0.137997,0.168128,0.014587,-0.039592,1.538332,-1.574014) +
            i[2] * mat4(0.298012,-0.011574,-0.053807,-0.059325,-0.110969,0.057967,0.093947,-0.561557,1.452848,-1.120168,-0.069146,-0.159305,0.000449,0.074902,0.039818,0.340928) +
            i[3] * mat4(0.027081,3.116374,0.130567,-0.027822,-1.217810,0.298920,0.077950,-0.194150,0.117902,0.099246,-0.104730,0.016827,-0.435162,0.002803,-0.000678,-0.003850) +
            i[4] * mat4(0.064229,0.047776,0.098088,0.025584,-0.416675,0.086293,1.143826,0.276083,0.063546,0.326130,-0.047654,-0.029619,0.001611,-0.014702,-0.001627,-0.034543) +
            i[5] * mat4(-0.000109,-0.028723,-0.019703,-0.063853,0.008633,-0.062076,0.448811,0.203927,-0.022649,0.046261,-0.024509,-0.100843,-0.000887,-0.003122,-0.000162,0.002002) +
            vec4(0.049008, -0.435025, 0.048031, 0.007097) * ii[4][4];
        imageStore(outFeatures[4], ivec2(gl_GlobalInvocationID.xy), sum);
        
        sum = vec4(0.03335, -0.00956, 0.01197, 0.01758) +
            i[0] * mat4(-0.023606,-0.084224,0.297727,-0.201692,0.004926,-0.107197,0.087297,0.537621,-0.064231,-0.035433,0.182793,0.067571,-0.095217,0.146237,-0.201771,0.112652) +
            i[1] * mat4(0.017587,0.062008,-0.050854,1.345676,-0.000696,-0.066705,-0.504240,-0.651227,-0.083824,0.030367,-0.040655,0.017784,-0.018562,0.208512,1.227950,-1.205137) +
            i[2] * mat4(-1.421177,0.119428,-0.005118,-0.011291,0.524557,0.410615,0.443093,0.095125,0.061970,-0.201495,0.153435,-0.204794,0.050615,-0.028995,-0.492230,-1.159553) +
            i[3] * mat4(0.362634,-0.393522,0.042826,-0.014857,-1.253214,-0.617606,-0.222647,0.262480,-0.190264,0.763509,-0.258532,-0.001027,1.485306,-0.027046,0.126516,0.312864) +
            i[4] * mat4(-0.024983,0.092631,-0.034728,-0.024762,0.989210,0.117765,-0.108167,-0.059290,-0.261786,-1.335983,1.303369,0.433212,-0.124894,-0.106626,-0.074196,-0.038357) +
            i[5] * mat4(0.021839,-0.040165,0.044888,-0.031698,-0.314135,0.234848,0.175026,-0.017996,0.052623,0.235662,-0.468642,-0.301040,-0.001753,-0.069490,0.086335,-0.083451) +
            vec4(0.029764, 0.058024, 0.092488, 0.043209) * ii[4][4];
        imageStore(outFeatures[5], ivec2(gl_GlobalInvocationID.xy), sum);
        
    }
    )